# 彩虹城浏览器 (Rainbowcity-Browser) - 金券：契约与标准 V8.0

## **章节：1.1 API 规约 (API Specification)**

## **一、定位与使命 (Positioning & Mission)**

### **1.1 模块定位**
本规约是彩虹城浏览器V8.0对外部AI生态的**统一决策接口协议**。它不再仅仅是数据交换的通道，而是AI决策系统的神经网络入口，是智能感知与精准执行的桥梁。

### **1.2 核心问题**
本规约旨在解决一个根本问题：如何以一种**极简、智能、自适应**的方式，让AI系统能够与V8.0的3层感知架构和12个标准工具无缝协作，实现最优的决策执行效果？

### **1.3 应用场景**
- 一个基于GPT-4的Agent，需要分析复杂网页内容。它将通过智能感知接口自动选择合适的感知层级（Fast/Standard/Deep），获得最优性价比的感知结果。
- 一个自动化系统，需要执行复杂的多步骤任务。它将通过标准化工具接口，使用12个精确定义的工具完成导航、交互、记忆、元认知等操作。
- 一位AI研究员，需要分析系统决策过程。他将通过透明化的决策API，查看完整的感知-决策-执行链路和性能指标。

### **1.4 能力边界**
- **本规约做什么**: 定义智能感知接口、标准工具调用、决策透明化、系统健康监控。专注于"如何交互"的精确定义。
- **本规约不做什么**: 不关心V8.0内部的简化实现细节（这是`水卷`的职责）。不规定开发者的具体使用方式（这是`木卷`的领域）。

## **二、设计思想与哲学基石 (Design Philosophy & Foundational Principles)**

V8.0 API规约体现了"大道至简"的核心哲学：

1. **以"简约"为设计核心 (`大道至简`)**: 3层感知替代4层，12个工具覆盖全场景，核心API控制在20个以内。

2. **以"智能"为交互方式 (`机巧若神`)**: API具备自适应能力，可根据场景自动优化参数和执行策略。

3. **以"透明"为信任基础 (`明镜高悬`)**: 所有决策过程可追踪，性能指标实时可见，错误诊断智能化。

4. **以"标准"为协作语言 (`金之刚性`)**: 严格的接口规范，确保跨平台、跨语言的一致性体验。

5. **以"演进"为发展动力 (`与时俱进`)**: 保持向后兼容的同时，为未来创新预留接口扩展空间。

## **三、API 规约正文 (OpenAPI 3.1.0)**

```yaml
# 彩虹城浏览器 V8.0 - 金券：契约与标准
# 章节 1.1: API 规约

openapi: 3.1.0
info:
  title: Rainbowcity-Browser V8.0 - Intelligent Decision API
  description: |
    为AI Agent提供智能决策能力的下一代浏览器API。
    V8.0以简约而强大的设计，提供3层感知架构和12个标准化工具。
    
    V8.0核心特性：
    - 智能3层感知架构（Fast/Standard/Deep）
    - 12个标准化工具覆盖全场景
    - 自适应决策引擎
    - 透明化执行过程
    - 30%性能提升
    - 70%复杂度降低
  version: 8.0.0
  contact:
    name: 彩虹城8.0架构团队
    
servers:
  - url: http://localhost:8223/v8
    description: 本地运行的Rainbowcity-Browser V8.0实例

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      description: "V8.0增强安全token，支持会话隔离和权限细粒度控制。"
  
  schemas:
    # ==================== 会话管理模型 ====================
    SessionConfig:
      type: object
      description: "V8.0会话配置，智能默认值减少配置复杂度"
      properties:
        browser_engine:
          type: string
          enum: [chromium, firefox, webkit]
          default: chromium
          description: "浏览器引擎选择"
        viewport:
          $ref: '#/components/schemas/Viewport'
        performance_mode:
          type: string
          enum: [efficiency, balanced, performance]
          default: balanced
          description: "V8.0性能模式：效率优先/平衡/性能优先"
        adaptive_sensing:
          type: boolean
          default: true
          description: "V8.0自适应感知：智能选择最优感知层级"
        enable_decision_trace:
          type: boolean
          default: false
          description: "V8.0决策追踪：可视化决策过程"
      additionalProperties: false
    
    Session:
      type: object
      description: "V8.0会话状态，增强的健康监控和性能指标"
      properties:
        session_id:
          type: string
          format: uuid
          description: "会话唯一标识符"
        status:
          type: string
          enum: [active, paused, terminated, error, recovering]
          description: "V8.0增加recovering状态，支持智能恢复"
        created_at:
          type: string
          format: date-time
        config:
          $ref: '#/components/schemas/SessionConfig'
        health_metrics:
          $ref: '#/components/schemas/HealthMetrics'
        performance_summary:
          $ref: '#/components/schemas/PerformanceSummary'
        active_tabs:
          type: array
          items:
            $ref: '#/components/schemas/TabInfo'
          description: "活跃标签页列表"
      required: [session_id, status, created_at, config]

    # ==================== V8.0智能感知模型 ====================
    PerceptionMode:
      type: string
      enum: [fast, standard, deep, adaptive]
      description: |
        V8.0三层感知架构：
        - fast: <50ms 快速概览，替代7.0的Lightning
        - standard: <200ms 标准理解，优化的快速分析  
        - deep: <500ms 深度洞察，全面理解
        - adaptive: 智能选择最优层级

    IntelligentPerceptionResult:
      type: object
      description: "V8.0智能感知结果，统一的3层架构输出"
      properties:
        mode_used:
          $ref: '#/components/schemas/PerceptionMode'
          description: "实际使用的感知模式"
        fast_data:
          $ref: '#/components/schemas/FastPerception'
          description: "Fast层数据（所有模式都包含）"
        standard_data:
          $ref: '#/components/schemas/StandardPerception'
          description: "Standard层数据（Standard/Deep模式包含）"
        deep_data:
          $ref: '#/components/schemas/DeepPerception'
          description: "Deep层数据（仅Deep模式包含）"
        processing_metrics:
          type: object
          properties:
            actual_time_ms:
              type: integer
              description: "实际处理时间"
            efficiency_score:
              type: number
              minimum: 0
              maximum: 1
              description: "效率评分（时间vs质量）"
            resource_usage:
              type: object
              description: "资源使用情况"
        decision_context:
          type: object
          description: "V8.0决策上下文，解释为什么选择此感知模式"
      required: [mode_used, fast_data, processing_metrics]

    # ==================== 3层感知数据结构 ====================
    FastPerception:
      type: object
      description: "Fast模式感知（<50ms），优化的快速识别"
      properties:
        page_ready:
          type: boolean
          description: "页面就绪状态"
        key_elements:
          type: array
          items:
            $ref: '#/components/schemas/CoreElement'
          maxItems: 10
          description: "关键可交互元素"
        urgent_signals:
          type: array
          items:
            type: string
          description: "紧急信号（错误、弹窗等）"
        layout_stability:
          type: number
          minimum: 0
          maximum: 1
          description: "布局稳定性评分"
      required: [page_ready, key_elements]

    StandardPerception:
      type: object
      description: "Standard模式感知（<200ms），平衡的深度分析"
      properties:
        enhanced_elements:
          type: array
          items:
            $ref: '#/components/schemas/EnhancedElement'
          maxItems: 30
          description: "增强的元素信息"
        page_context:
          $ref: '#/components/schemas/PageContext'
          description: "页面上下文信息"
        interaction_map:
          type: object
          description: "交互关系映射"
        content_analysis:
          type: object
          description: "内容语义分析"
      required: [enhanced_elements, page_context]

    DeepPerception:
      type: object
      description: "Deep模式感知（<500ms），全面的理解分析"
      properties:
        semantic_understanding:
          type: object
          description: "语义理解结果"
        workflow_analysis:
          type: object
          description: "工作流程分析"
        performance_insights:
          type: object
          description: "性能洞察"
        accessibility_audit:
          type: object
          description: "可访问性审计"
        predictive_elements:
          type: array
          description: "预测性元素识别"
      required: [semantic_understanding, workflow_analysis]

    # ==================== 标准化工具模型 ====================
    StandardTool:
      type: object
      description: "V8.0标准化工具调用"
      properties:
        tool_id:
          type: string
          format: uuid
          description: "工具调用唯一标识"
        tool_name:
          type: string
          enum: [
            navigate_to_url,
            scroll_page,
            click,
            type_text,
            select_option,
            wait_for_element,
            wait_for_condition,
            get_element_info,
            take_screenshot,
            retrieve_history,
            report_insight,
            complete_task
          ]
          description: "12个标准化工具名称"
        parameters:
          type: object
          description: "工具参数（根据工具类型定义）"
          additionalProperties: true
        execution_options:
          $ref: '#/components/schemas/ExecutionOptions'
          description: "V8.0执行选项"
      required: [tool_id, tool_name, parameters]

    ExecutionOptions:
      type: object
      description: "V8.0标准化执行选项"
      properties:
        timeout_ms:
          type: integer
          minimum: 100
          maximum: 30000
          default: 5000
          description: "执行超时时间"
        retry_policy:
          type: string
          enum: [none, simple, smart, adaptive]
          default: smart
          description: "重试策略"
        error_recovery:
          type: boolean
          default: true
          description: "启用智能错误恢复"
        performance_priority:
          type: string
          enum: [speed, accuracy, balance]
          default: balance
          description: "性能优先级"
      additionalProperties: false

paths:
  # ==================== 会话管理 ====================
  /sessions:
    post:
      summary: 创建智能会话
      description: |
        创建一个V8.0智能会话。每个会话都是独立的决策空间，
        具备自适应能力和智能资源管理。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SessionConfig'
      responses:
        '201':
          description: 会话创建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Session'
                
  /sessions/{sessionId}:
    get:
      summary: 获取会话智能状态
      description: |
        获取会话的智能状态，包括健康指标、性能分析、
        决策历史等完整信息。
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 会话状态获取成功
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/Session'
                  - type: object
                    properties:
                      decision_history:
                        type: array
                        description: "决策历史记录"
                      performance_analytics:
                        type: object
                        description: "性能分析报告"
          
    delete:
      summary: 优雅关闭会话
      description: 智能地关闭会话，保存重要状态，释放所有资源。
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: 会话关闭成功

  # ==================== V8.0智能感知 ====================
  /sessions/{sessionId}/perception:
    post:
      summary: 智能感知请求
      description: |
        V8.0核心创新：智能3层感知架构。
        系统会根据页面特征和任务需求，自动选择最优的感知策略。
        
        感知层级：
        - fast: 极速概览，适合状态检查
        - standard: 标准理解，适合大多数任务
        - deep: 深度洞察，适合复杂分析
        - adaptive: 智能选择，系统自动优化
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                mode:
                  $ref: '#/components/schemas/PerceptionMode'
                target_elements:
                  type: array
                  items:
                    type: string
                  description: "关注的特定元素（可选）"
                context_hint:
                  type: string
                  description: "任务上下文提示，帮助优化感知策略"
                performance_preference:
                  type: string
                  enum: [speed, accuracy, balanced]
                  default: balanced
                  description: "性能偏好"
      responses:
        '200':
          description: 智能感知完成
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IntelligentPerceptionResult'

  # ==================== 标准化工具执行 ====================
  /sessions/{sessionId}/tools:
    post:
      summary: 执行标准化工具
      description: |
        执行V8.0的12个标准化工具。支持单个工具执行和批量执行，
        具备智能协调、错误恢复、性能优化等能力。
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                tools:
                  type: array
                  items:
                    $ref: '#/components/schemas/StandardTool'
                  minItems: 1
                  maxItems: 10
                  description: "要执行的工具列表"
                execution_strategy:
                  type: string
                  enum: [sequential, parallel, intelligent]
                  default: intelligent
                  description: "执行策略"
                global_options:
                  $ref: '#/components/schemas/ExecutionOptions'
                  description: "全局执行选项"
      responses:
        '202':
          description: 工具执行已启动（异步）
          content:
            application/json:
              schema:
                type: object
                properties:
                  execution_id:
                    type: string
                    format: uuid
                  tools_accepted:
                    type: integer
                  estimated_completion_ms:
                    type: integer
                  execution_plan:
                    type: object
                    description: "执行计划详情"

  # ==================== 执行状态查询 ====================
  /sessions/{sessionId}/executions/{executionId}:
    get:
      summary: 查询执行状态
      description: 查询工具执行的实时状态和结果。
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
        - name: executionId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 执行状态
          content:
            application/json:
              schema:
                type: object
                properties:
                  execution_id:
                    type: string
                  status:
                    type: string
                    enum: [pending, running, completed, failed, recovering]
                  progress:
                    type: number
                    minimum: 0
                    maximum: 1
                  tools_results:
                    type: array
                    items:
                      type: object
                  performance_metrics:
                    type: object
                  error_details:
                    type: object

  # ==================== V8.0系统监控 ====================
  /health:
    get:
      summary: 系统健康检查
      description: |
        V8.0增强的健康监控，提供实时系统状态、
        性能指标、决策质量评估等信息。
      responses:
        '200':
          description: 系统健康
          content:
            application/json:
              schema:
                type: object
                properties:
                  overall_health:
                    type: string
                    enum: [excellent, good, degraded, critical]
                  system_metrics:
                    type: object
                    properties:
                      cpu_usage:
                        type: number
                      memory_usage:
                        type: number
                      active_sessions:
                        type: integer
                  performance_summary:
                    type: object
                    properties:
                      avg_perception_time:
                        type: object
                      tool_success_rate:
                        type: number
                      decision_accuracy:
                        type: number
                  intelligent_insights:
                    type: array
                    items:
                      type: string
                    description: "系统智能洞察"

  /metrics:
    get:
      summary: 详细性能指标
      description: |
        获取详细的系统性能指标，包括各层感知效率、
        工具执行统计、资源使用趋势等。
      responses:
        '200':
          description: 性能指标
          content:
            application/json:
              schema:
                type: object
                properties:
                  perception_metrics:
                    type: object
                    properties:
                      fast_avg_ms:
                        type: number
                      standard_avg_ms:
                        type: number
                      deep_avg_ms:
                        type: number
                      adaptive_efficiency:
                        type: number
                  tool_metrics:
                    type: object
                    additionalProperties:
                      type: object
                      properties:
                        success_rate:
                          type: number
                        avg_duration_ms:
                          type: number
                        error_recovery_rate:
                          type: number
                  resource_metrics:
                    type: object
                    properties:
                      memory_efficiency:
                        type: number
                      cpu_optimization:
                        type: number
                      cache_hit_rate:
                        type: number

security:
  - BearerAuth: []
```

## **四、V8.0 API核心创新**

### **4.1 智能感知架构**
```yaml
3层感知优势:
  简化决策: 减少选择复杂度，提高决策效率
  性能优化: Fast层<50ms，满足99%快速响应需求
  智能适配: adaptive模式根据场景自动选择最优策略
  
自适应感知:
  页面复杂度评估: 自动分析页面结构复杂度
  任务类型识别: 根据历史行为预测最佳感知层级
  资源状态考量: 结合系统负载动态调整策略
```

### **4.2 标准化工具体系**
```yaml
12个标准工具覆盖:
  导航类(2): navigate_to_url, scroll_page
  交互类(3): click, type_text, select_option  
  同步类(2): wait_for_element, wait_for_condition
  记忆类(3): get_element_info, take_screenshot, retrieve_history
  元认知类(2): report_insight, complete_task

执行优化:
  智能协调: 自动识别工具间依赖关系
  并行执行: 支持无依赖工具的并行执行
  错误恢复: 90%常见错误自动修复
  性能监控: 实时工具执行效率分析
```

### **4.3 透明化决策**
```yaml
决策追踪:
  - 感知模式选择依据
  - 工具执行策略制定
  - 错误恢复决策路径
  - 性能优化调整逻辑

可视化支持:
  - 决策树展示
  - 执行时间线
  - 资源使用图表
  - 错误分析报告
```

## **五、响应状态码与错误处理**

### **5.1 HTTP状态码规范**
```yaml
2xx 成功:
  200 OK: 请求成功，返回结果
  201 Created: 资源创建成功
  202 Accepted: 异步请求已接受，返回执行ID

4xx 客户端错误:
  400 Bad Request: 请求参数错误
  401 Unauthorized: 认证失败
  404 Not Found: 资源不存在
  409 Conflict: 请求冲突（如会话已存在）
  429 Too Many Requests: 请求频率超限

5xx 服务器错误:
  500 Internal Server Error: 服务器内部错误
  503 Service Unavailable: 服务暂时不可用
  504 Gateway Timeout: 执行超时
```

### **5.2 智能错误恢复**
```yaml
错误分类:
  可恢复错误: 自动重试和修复
  部分失败: 继续执行其他操作
  致命错误: 优雅降级和状态保存

恢复策略:
  网络错误: 指数退避重试
  元素不存在: 重新感知页面
  执行超时: 调整策略重试
  资源不足: 暂停执行，释放资源
```

## **六、与水卷的深度集成**

### **6.1 API与水卷模块映射**
```yaml
API层 → 水卷模块:
  /perception → Layered-Perception
  /tools → Intelligent-Action  
  /sessions → Unified-Kernel
  /health → HealthGuardian
  /metrics → ResourceManager
```

### **6.2 决策协同机制**
- **StateCenter集成**：所有API调用通过事件总线协调
- **HealthGuardian监控**：API性能实时监控和预警
- **ResourceManager优化**：基于API使用模式优化资源分配

## **七、开发者友好特性**

### **7.1 智能API建议**
- **上下文感知**：根据当前会话状态推荐最佳API调用
- **性能预测**：提前预估API调用的资源消耗和执行时间
- **错误预防**：智能检查参数合法性，提供修正建议

### **7.2 丰富的调试支持**
- **执行追踪**：完整的API调用链路追踪
- **性能分析**：详细的性能瓶颈分析
- **错误诊断**：智能的错误原因分析和解决建议

---

> *"简约而不简单，智能而不复杂。V8.0 API规约，让AI决策如剑锋般精准。"*

**文档版本**: V8.0  
**创建时间**: 2024-01  
**文档状态**: ✅ 规约确立  
**稳定等级**: 🏆 生产就绪